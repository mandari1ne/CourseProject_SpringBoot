<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea, #764ba2); /* –¶–≤–µ—Ç–∞ –∏–∑ login.html */
            font-family: 'Segoe UI', sans-serif;
        }

        .container {
            margin-top: 60px;
            max-width: 98%;
        }

        h2 {
            color: #fff;
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .table-container {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .table thead th {
            background-color: #6a11cb;
            color: #ffffff;
            vertical-align: middle;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .table {
            font-size: 0.85rem;
            table-layout: auto;
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #5a5a89;
        }

        .table th, .table td {
            vertical-align: middle;
            text-align: center;
            padding: 8px;
            border: 1px solid #5a5a89;
        }

        .table th:nth-child(3),
        .table th:nth-child(4) {
            width: 160px;
        }

        .form-select {
            border-radius: 8px;
            font-size: 0.8rem;
            padding: 4px 6px;
            width: 100%;
            min-width: 130px;
        }

        .btn-primary {
            border-radius: 25px;
            font-weight: 600;
            background-color: #6a11cb;
            border: none;
            font-size: 0.8rem;
            padding: 6px 12px;
            transition: 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #2575fc;
        }

        .btn-secondary {
            margin-top: 20px;
            border-radius: 25px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border: none;
            font-weight: 600;
            transition: 0.3s ease;
            font-size: 0.9rem;
            padding: 8px 20px;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e67e22, #f39c12);
        }

        .no-access {
            background: #ffe0e0;
            padding: 20px;
            border-radius: 10px;
            color: #c0392b;
            font-weight: bold;
            text-align: center;
        }

        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            border-radius: 25px;
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: #fff;
            padding: 8px 20px;
            font-weight: bold;
            text-decoration: none;
            transition: 0.3s ease;
        }

        .back-button:hover {
            background: linear-gradient(135deg, #ff4b2b, #ff416c);
        }
    </style>

    <script>
        function updateUserStatusAndRole(userId) {
            const role = document.getElementById(`role-${userId}`).value;
            const status = document.getElementById(`status-${userId}`).value;

            fetch(`/admin/update-user/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ role, status }),
            })
                .then(response => {
                    if (response.ok) {
                        alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                        window.location.reload();
                    } else {
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
                });
        }

        function filterByDepartment() {
            const selectedDept = document.getElementById('departmentFilter').value.toLowerCase();
            const rows = document.querySelectorAll('table tbody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const deptCell = row.cells[7];
                const deptText = deptCell.textContent.trim().toLowerCase();

                if (selectedDept === 'all' || deptText === selectedDept) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            const message = document.getElementById('noResultsMessage');
            if (visibleCount === 0) {
                message.style.display = 'block';
            } else {
                message.style.display = 'none';
            }
        }

        function deleteUser(userId) {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) {
                fetch(`/admin/delete-user/${userId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!");
                            window.location.reload();
                        } else {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
                        }
                    })
                    .catch(error => {
                        console.error("–û—à–∏–±–∫–∞:", error);
                        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.");
                    });
            }
        }

    </script>
</head>
<body>

<div class="container">
    <h2 class="text-center">üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>

    <div class="table-container" th:if="${role == 'ROLE_ADMIN'}">
        <div class="mb-3 d-flex justify-content-end">
            <label class="text-white me-2 fw-semibold" for="departmentFilter">–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ç–¥–µ–ª—É:</label>
            <select id="departmentFilter" class="form-select w-auto" onchange="filterByDepartment()">
                <option value="all">–í—Å–µ –æ—Ç–¥–µ–ª—ã</option>
                <option value="Development">Development</option>
                <option value="QA">QA</option>
                <option value="DevOps">DevOps</option>
                <option value="Support">Support</option>
                <option value="Managment">Managment</option>
                <option value="Data Science">Data Science</option>
                <option value="Desing">Desing</option>
                <option value="HR">HR</option>
                <option value="Sales">Sales</option>
                <option value="Marketing">Marketing</option>
                <option value="Finance">Finance</option>
            </select>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>–õ–æ–≥–∏–Ω</th>
                    <th>–†–æ–ª—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–§–∞–º–∏–ª–∏—è</th>
                    <th>–ò–º—è</th>
                    <th>–û—Ç—á–µ—Å—Ç–≤–æ</th>
                    <th>–û—Ç–¥–µ–ª</th>
                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                    <th>Email</th>
                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${users}">
                    <td th:text="${user.id}"></td>
                    <td th:text="${user.login}"></td>

                    <td>
                        <select class="form-select" th:id="'role-' + ${user.id}">
                            <option th:value="MANAGER" th:selected="${user.role.name() == 'MANAGER'}">MANAGER</option>
                            <option th:value="USER" th:selected="${user.role.name() == 'USER'}">USER</option>
                        </select>
                    </td>

                    <td>
                        <select class="form-select" th:id="'status-' + ${user.id}">
                            <option th:value="ACTIVE" th:selected="${user.status.name() == 'ACTIVE'}">ACTIVE</option>
                            <option th:value="BLOCKED" th:selected="${user.status.name() == 'BLOCKED'}">BLOCKED</option>
                        </select>
                    </td>

                    <td th:text="${user.userInfo?.surname ?: ''}"></td>
                    <td th:text="${user.userInfo?.name ?: ''}"></td>
                    <td th:text="${user.userInfo?.patronymic ?: ''}"></td>
                    <td th:text="${user.userInfo?.department ?: ''}"></td>
                    <td th:text="${user.userInfo?.position ?: ''}"></td>
                    <td th:text="${user.userInfo?.email ?: ''}"></td>
                    <td>
                        <button class="btn btn-primary btn-sm mb-1" th:onclick="'updateUserStatusAndRole(' + ${user.id} + ')'">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn btn-danger btn-sm" th:onclick="'deleteUser(' + ${user.id} + ')'">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div id="noResultsMessage" class="text-center fw-bold py-3 text-danger" style="display: none;">
                ‚ùó –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            </div>

        </div>
    </div>

    <div class="no-access" th:if="${role != 'ROLE_ADMIN'}">
        ‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
    </div>

    <div class="text-center">
        <a href="/auth/home" class="back-button">‚¨Ö –ù–∞–∑–∞–¥</a>
    </div>
</div>

</body>
</html>
